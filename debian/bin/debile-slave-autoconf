#!/bin/bash
# Such bash. Very non-POSIX. Much needed.
#
# Copyright (c) Paul R. Tagliamonte <paultag@debian.org>, 2013, under the
# terms and conditions of the Expat license, as noted in the Debile project
# LICENSE file.
set -e

AUTOCONF_SCRIPT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DEBILE_UNPRIV="Debian-debile-unpriv"

function debile-run {
    su -s /bin/sh \
       -c $@ \
       ${DEBILE_UNPRIV}
}

echo "  == auto-set up debile =="
echo ""
echo "Getting (or generating) the OpenPGP command."
echo ""
echo "    If this is the first run, this can take"
echo "    up to like 5 minutes. Don't C-c it if you"
echo "    can help it."
echo ""

FINGERPRINT=$(debile-run \
    "${AUTOCONF_SCRIPT_ROOT}/debile-slave-autoconf-openpgp")

echo ""
echo " Got our key, it's ${FINGERPRINT}."
echo ""

${AUTOCONF_SCRIPT_ROOT}/debile-slave-autoconf-yaml ${FINGERPRINT}

echo ""
echo " OK, I set up the YAML file too."
echo ""
