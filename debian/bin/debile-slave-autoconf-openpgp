#!/bin/bash
# Such bash. Very non-POSIX.

# Copyright (c) Paul R. Tagliamonte <paultag@debian.org>, 2013, under the
# terms and conditions of the Expat license, as noted in the Debile project
# LICENSE file.

GPG_COMMAND=gpg  # Let's use gpg2 at some point soon?

GPG_USER="$(whoami)@$(hostname)"
GPG_NAME="Debile Autobuilder"

function get-fingerprint {
    GPG_FINGERPRINT=$(${GPG_COMMAND} --fingerprint ${GPG_USER} \
        | grep "Key fingerprint = " \
        | sed 's/Key fingerprint =//g' \
        | tr -d " " \
        | head -n 1)
    echo ${GPG_FINGERPRINT}
}

if [ "x`get-fingerprint`" = "x" ]; then
    echo "There doesn't appear to be a Debile slave key."
    echo ""
    echo "         I'm going to create a key for us now."
    echo "                 The UID will be:"
    echo "  \"${GPG_NAME} <${GPG_USER}> (Debile Slave Key)\""
    echo ""
    echo "    BTW; for real, this will take a hot minute to generate."
    echo "    Don't C-c me unless it's been more than like 10 minutes."

    ${GPG_COMMAND} --gen-key --batch <<EOF
        Key-Type: RSA
        Key-Length: 2048
        Name-Real: ${GPG_NAME}
        Name-Comment: Debile Slave Key
        Name-Email: ${GPG_USER}
        %commit
        %echo Done
EOF
fi

GPG_FINGERPRINT=`get-fingerprint`

echo "OK. You've been issued ${GPG_FINGERPRINT} by the OpenPGP gods."
