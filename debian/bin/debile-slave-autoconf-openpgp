#!/bin/bash
# Such bash. Very non-POSIX.

# Copyright (c) Paul R. Tagliamonte <paultag@debian.org>, 2013, under the
# terms and conditions of the Expat license, as noted in the Debile project
# LICENSE file.

GPG_COMMAND=gpg  # Let's use gpg2 at some point soon?

GPG_USER="$(whoami)@$(hostname)"
GPG_NAME="Debile Autobuilder"

function get-fingerprint {
    GPG_FINGERPRINT=$(${GPG_COMMAND} --fingerprint ${GPG_USER} 2>/dev/null \
        | grep "Key fingerprint = " \
        | sed 's/Key fingerprint =//g' \
        | tr -d " " \
        | head -n 1)
    echo ${GPG_FINGERPRINT}
}

if [ "x`get-fingerprint`" = "x" ]; then
    # Ugh. Let's make a key.
    #
    ${GPG_COMMAND} -q --gen-key --batch 2>/dev/null <<EOF
        Key-Type: RSA
        Key-Length: 2048
        Name-Real: ${GPG_NAME}
        Name-Comment: Debile Slave Key
        Name-Email: ${GPG_USER}
        %commit
        %echo Done
EOF
fi

GPG_FINGERPRINT=`get-fingerprint`
echo ${GPG_FINGERPRINT}
